/*!
 * jQuery table-sorter plugin
 *
 * Copyright 2011, Zhulanov Vadim
 * Liscensed under the MIT License
 * http://github.com/maiordom/table-sorter/MIT-LICENSE.txt
 *
 * Date: 11/09/2011
 *
 * @requires jQuery v1.3.2 or later
 *
 * @example $('table').tableSorter();
 *
 * @requires CSS class "empty-object", "edit-mode-on"
 * @example
 * .empty-object {background:#034 !important; color:#034 !important;}
 */
(function(c){var b=[];function d(f,g){if(b.length===0){return f.filter("table")}var e=[];f.filter("table").each(function(){for(var k=0,h=0;k<b.length;k++){if(b[k].target===this){try{b[k][g]()}catch(l){}}else{h++}}if(h===b.length){e.push(this)}});return c(e)}function a(n,l){var f=c(n).children(),k=f.filter("tfoot"),j,m,e=true,g="addCol addRow delRow delCol".split(" ");if(f.filter("tbody").children().length===0){if(k.length===0){k=c("<tfoot>").appendTo(n);e=false}j=c("<tr>").appendTo(k);for(var h=0;h<g.length;h++){m=c("<input>",{type:"button",value:g[h]});j.append(c("<td>").append(m));(function(i){m.click(function(){l[i]()})})(g[h])}m=c("<input>",{type:"button",value:"disableEditMode"});j.append(c("<td>").append(m));m.click(function(){if(e){j.remove()}else{k.remove()}})}}c.fn.tableSorter=function(e){d(this,e).each(function(Q){var s=null,V,k,P,O,G,M,g=[],z=c("<div></div>"),j=c("<div></div>"),E=[],y,o=false,r=this,J=r.tBodies[0],x=r.tHead,R=J.children,q=c(R).children().filter("th");function h(){var i=c(r).offset();y={xmin:i.left,ymin:i.top,xmax:i.left+r.offsetWidth,ymax:i.top+r.offsetHeight}}h();function S(i){O=c(i).clone(false).css({margin:0,zIndex:1,position:"absolute"}).appendTo(z);O.children().filter("thead, tfoot").remove();G=O.clone(false).appendTo(j);l(O);G.find("tbody").empty()}function l(i){i.children().children().empty()}function F(i){i.children().filter("tbody").empty()}function C(){P==="rows"?G.appendTo(j):O.appendTo(z);c(".empty-temp").removeClass("empty-object").removeClass("empty-temp");if(o){c(r).css("height","");o=false}}function K(ab,W){E=[];for(var Y=0;Y<ab.length;Y++){var X=ab[Y],aa=c(X).offset(),Z=parseInt(X.offsetWidth),ac=parseInt(X.offsetHeight);E.push({xmin:aa.left,xmax:aa.left+Z,ymin:aa.top,ymax:W===true?y.ymax:aa.top+ac,dropTarget:X})}}function f(i){if(A(i)!==null){if(P==="cols"){I(i)}else{U(i)}}}function A(W){var i=W.pageX-y.xmin,X=W.pageY-y.ymin;if(i<0||i>y.xmax-y.xmin||X<0||X>y.ymax-y.ymin){return null}}function U(W){var i=n(W,"top");if(i&&i.rowIndex>M.rowIndex){c(i).insertBefore(M);K(R);return}i=n(W,"bottom");if(i&&i.rowIndex<M.rowIndex){c(i).insertAfter(M);K(R)}}function I(ac){var Z,W,ab,X=[],ad,aa;ab=c(M).parent()[0].rowIndex;Z=n(ac,"left");if(Z&&Z.cellIndex>M.cellIndex){W=c(J).children().filter(function(){if(this.rowIndex===ab||this.rowIndex>ab){X.push(c(this).children().eq(Z.cellIndex))}});W=X;for(var Y=0;Y<g.length;Y++){c(g[Y]).insertAfter(W[Y])}M=g[0];K(c(M).parent().children(),true);return}Z=n(ac,"right");if(Z&&Z.cellIndex<M.cellIndex){W=c(J).children().filter(function(){if(this.rowIndex===ab||this.rowIndex>ab){X.push(c(this).children().eq(Z.cellIndex))}});W=X;for(var Y=0;Y<g.length;Y++){c(g[Y]).insertBefore(W[Y])}M=g[0];K(c(M).parent().children(),true)}}function n(aa,X){for(var Y=0;Y<E.length;Y++){var Z=E[Y],ab=Z.xmin+(Z.xmax-Z.xmin)/2,W=Z.ymin+(Z.ymax-Z.ymin)/2;switch(X){case"left":if((aa.pageX>ab)&&(aa.pageX<Z.xmax)&&(aa.pageY>Z.ymin)&&(aa.pageY<Z.ymax)){return Z.dropTarget}break;case"right":if((aa.pageX<ab)&&(aa.pageX>Z.xmin)&&(aa.pageY>Z.ymin)&&(aa.pageY<Z.ymax)){return Z.dropTarget}break;case"top":if((aa.pageX>Z.xmin)&&(aa.pageX<Z.xmax)&&(aa.pageY>W)&&(aa.pageY<Z.ymax)){return Z.dropTarget}break;case"bottom":if((aa.pageX>Z.xmin)&&(aa.pageX<Z.xmax)&&(aa.pageY<W)&&(aa.pageY>Z.ymin)){return Z.dropTarget}break}}return false}function N(){c(document).bind({mousemove:function(i){u(i)},mouseup:function(i){D(i)}});document.ondragstart=function(){return false};document.body.onselectstart=function(){return false}}function B(){c(document).unbind("mousemove mouseup");document.ondragstart=null;document.body.onselectstart=null}function t(X,i,Y){var W=c(X).offset();return{x:i-W.left,y:Y-W.top}}function T(i){if(s){s.style.left=i.pageX-V.x+"px";s.style.top=i.pageY-V.y+"px";f(i)}}function w(i){return i.clone(false).css({height:i.height(),width:i.width()})}function H(i){var W=i.clone(false).empty();i.children().each(function(){c(this).clone(false).css({height:c(this).height(),width:c(this).width()}).appendTo(W)});return W}function v(Z){var X=Z.cellIndex,aa,ae,ac=c(Z).offset(),W,ad,Y;g=[Z];O.width(c(Z).outerWidth()+O[0].getAttribute("cellspacing")*2+O[0].getAttribute("border")*2);Y=O.children().children();Y.filter("tr:first").append(w(c(Z)));ae=Y.slice(1).show();c(Z).addClass("empty-temp");ad=c(M).parent()[0].rowIndex;W=c(J).children().filter(function(){if(this.rowIndex>ad){return this}}).get();for(var ab=0;ab<W.length;ab++){aa=c(W[ab]).children().eq(X);g.push(aa[0]);c(ae[ab]).append(w(aa));aa.addClass("empty-temp")}ae.filter(function(){if(c(this).children().length===0){c(this).hide()}});O.css({left:ac.left,top:ac.top})}function L(i){var W=c(i).offset();G.width(c(i).width());G.append(H(c(i)));c("td",i).addClass("empty-temp");G.css({left:W.left,top:W.top})}function p(i){h();M=this;K(c(this).parent().children(),true);l(O);v(this);P="cols";k={x:i.pageX,y:i.pageY,dragObject:O[0]};N();return false}function m(i){if(r.style.height===""){o=true}c(r).height(c(r).height());h();M=this;K(R);F(G);L(this);P="rows";k={x:i.pageX,y:i.pageY,dragObject:G[0]};N();return false}function u(i){if(k){if(Math.abs(k.x-i.pageX)<10&&Math.abs(k.y-i.pageY)<10){return}s=k.dragObject;if(P==="rows"){G.appendTo("body")}else{O.appendTo("body")}V=t(s,k.x,k.y);k=null;c(".empty-temp").addClass("empty-object")}T(i)}function D(){if(!s){k=null}s=null;C();B()}c(q).bind("mousedown",p);c(R).bind("mousedown",m);S(r);b.push({target:r,stopRowsDrag:function(){c(R).unbind("mousedown")},stopColsDrag:function(){c(q).unbind("mousedown")},startRowsDrag:function(){c(R).bind("mousedown",m)},startColsDrag:function(){c(q).bind("mousedown",p)},addRow:function(){var Y=c("<tr>"),X=c(R).filter("tr:last").children().length,W=0;do{Y.append(c("<td>"));W++}while(W<X);Y.bind("mousedown",event,m).appendTo(r);R=J.children;h();O.append(c("<tr>"))},addCol:function(){c(R).each(function(){c(this).append(c("<td>"))});h()},delRow:function(W){var i=W===undefined?R.length-1:W-1;c(R[i]).remove();R=J.children;h();O.children().children().eq(i).remove()},delCol:function(i){var W,X=c(R[0]).children().length;if(i===undefined){W=X-1}else{if(i>X){return}else{W=i-1}}c(R).each(function(){c(this).children().eq(W).remove()});q=c(R).children().filter("th");h()},startEditMode:function(){var Y,W=null,Z,X,i;c(r).delegate("td, th","click",function(aa){if(c(this).hasClass("edit-mode-on")){return false}if(W!==null){W.trigger("focusout")}W=c("<textarea>");Z=c(this).addClass("edit-mode-on");X=Z.width()-4;i=Z.height()-4;Y=Z.text();Z.text("").append(W);W.val(Y).focus().css({display:"block",width:X,height:i}).focusout(function(){Y=W.val();W.remove();W=null;Z.text(Y).removeClass("edit-mode-on")}).keydown(function(ab){if(ab.keyCode===13||ab.keyCode===27){c(this).trigger("focusout")}}).click(function(ab){ab.stopPropagation()});aa.stopPropagation()})},stopEditMode:function(){c(r).unbind("click")}});a(r,b[b.length-1])})}})(jQuery);